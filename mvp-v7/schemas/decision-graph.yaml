$schema: http://json-schema.org/draft-07/schema#
title: AgentOS Decision Graph v1
type: object
required: [spec_version, name, description, nodes]
properties:
  spec_version:
    type: string
    const: "agentos.decision-graph/v1"
  name:
    type: string
  description:
    type: string
  context_contract:
    type: object
    description: "Optional declaration of the `context` fields this graph expects. This prevents implicit/undefined context usage."
    properties:
      required:
        type: array
        description: "List of required context fields (dot-paths) for evaluating this graph."
        items:
          type: object
          required: [path]
          properties:
            path:
              type: string
              description: "Dot-path inside `context`, e.g. `context.task.objective`."
            description:
              type: string
            type:
              type: string
              description: "Human hint for expected type (not enforced by schema)."
            enum:
              type: array
              items: { type: string }
            example:
              type: string
      optional:
        type: array
        description: "List of optional context fields (dot-paths) that may influence evaluation."
        items:
          type: object
          required: [path]
          properties:
            path: { type: string }
            description: { type: string }
            type: { type: string }
            enum:
              type: array
              items: { type: string }
            example: { type: string }
      notes:
        type: string
  expression_language:
    type: string
    enum: ["string", "cel", "json_logic"]
    default: "string"
  trace:
    type: object
    properties:
      enabled: { type: boolean, default: true }
      display_policy:
        type: string
        enum: ["auto_when_asking", "on_request", "always"]
        default: "auto_when_asking"
  nodes:
    type: array
    minItems: 1
    items:
      type: object
      oneOf:
        - title: decision node
          type: object
          required: [id, type, when, then, else]
          properties:
            id: { type: string }
            type: { type: string, const: "decision" }
            question: { type: string }
            when: { type: string, description: "Condition expression evaluated against `context`." }
            then: { type: string, description: "Next node id if condition is true." }
            else: { type: string, description: "Next node id if condition is false." }
            anchors_used: { type: array, items: { type: string } }
            provenance:
              type: object
              description: "Deprecated for origin-tracking; prefer decision traces (`graph_stack`). Kept for authoring metadata."
              properties:
                source_kind:
                  type: string
                  enum: ["kernel_default", "rule", "user_mention", "manual_insert", "search_suggested", "command", "skill"]
                source_ref: { type: string }

        - title: decision table node
          type: object
          required: [id, type, rules]
          properties:
            id: { type: string }
            type: { type: string, const: "decision_table" }
            hit_policy:
              type: string
              enum: ["first", "collect", "priority"]
              default: "first"
            rules:
              type: array
              minItems: 1
              items:
                type: object
                required: [id, when, output]
                properties:
                  id: { type: string }
                  when: { type: string }
                  output:
                    type: object
                    properties:
                      route: { type: string }
                      load: { type: array, items: { type: string } }
                      confidence: { type: number, minimum: 0, maximum: 1 }
                      mode: { type: string, enum: ["trial", "installed", "ask_user"] }
            anchors_used: { type: array, items: { type: string } }
            provenance:
              type: object
              description: "Deprecated for origin-tracking; prefer decision traces (`graph_stack`). Kept for authoring metadata."
              properties:
                source_kind:
                  type: string
                  enum: ["kernel_default", "rule", "user_mention", "manual_insert", "search_suggested", "command", "skill"]
                source_ref: { type: string }

        - title: ask node
          type: object
          required: [id, type, ask]
          properties:
            id: { type: string }
            type: { type: string, const: "ask" }
            ask:
              type: object
              required: [questions]
              properties:
                prompt: { type: string }
                questions:
                  type: array
                  minItems: 1
                  items:
                    type: object
                    required: [id, text, options]
                    properties:
                      id: { type: string }
                      text: { type: string }
                      options: { type: array, items: { type: string }, minItems: 1 }
                      default: { type: string }
                      branch_default:
                        type: string
                        enum: ["new_branch", "refinement"]
                        default: "new_branch"
            anchors_used: { type: array, items: { type: string } }
            provenance:
              type: object
              description: "Deprecated for origin-tracking; prefer decision traces (`graph_stack`). Kept for authoring metadata."
              properties:
                source_kind:
                  type: string
                  enum: ["kernel_default", "rule", "user_mention", "manual_insert", "search_suggested", "command", "skill"]
                source_ref: { type: string }

        - title: terminal node
          type: object
          required: [id, type]
          properties:
            id: { type: string }
            type: { type: string, const: "terminal" }
            output:
              type: object
              properties:
                route: { type: string }
                load: { type: array, items: { type: string } }
                confidence: { type: number, minimum: 0, maximum: 1 }
                mode: { type: string, enum: ["trial", "installed", "ask_user"] }
                next_graph: { type: string }
            anchors_used: { type: array, items: { type: string } }
            provenance:
              type: object
              description: "Deprecated for origin-tracking; prefer decision traces (`graph_stack`). Kept for authoring metadata."
              properties:
                source_kind:
                  type: string
                  enum: ["kernel_default", "rule", "user_mention", "manual_insert", "search_suggested", "command", "skill"]
                source_ref: { type: string }

